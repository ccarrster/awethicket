<!DOCTYPE html>
<html>
<head>
<title>Awe Thicket</title>
<style>

</style>
</head>
<body>
<script src="jquery-3.3.1.min.js"></script>
<script>
    var numberOfPlayers = null;
    var firstPlayer = null;
    var mushroomBoards = [];
    var crateNumbers = [1, 2, 3, 4, 4];
    var mushroomNames = ['Girolles', 'Morels', 'Boletes', 'Parasol'];
    var playerColors = ['Blue', 'Green', 'Purple', 'Red', 'Orange'];
    var players = [];
    var currentPlayer = null;
    var scores = [1, 3, 5, 7];
    var informationFlipDeck = null;
    var winners = null;
    var startSharePlayer = null;
    

    class player{
        constructor(inPlayerIndex){
            this.playerIndex = inPlayerIndex;
            this.availableCrates = null;
            this.maxAvailableCrates = null;
            this.mushrooms = [0, 0, 0, 0];
            this.informationPieces = [];
            this.points = 0;
            this.skipped = null;
        }
    }
    class mushroomBoard{
        constructor(inMushroomType, inNumPlayers){
            this.mushroomType = inMushroomType;
            this.crates = [null, null, null, null, null];
            this.information = null;
            this.mushroomQuantity = 0;
            this.sharedInformation = [];
            if(inNumPlayers == 2){
                this.mushroomQuantity = 8;
            } else if(inNumPlayers == 3){
                this.mushroomQuantity = 10;
            } else if(inNumPlayers == 4){
                this.mushroomQuantity = 12;
            } else if(inNumPlayers == 5){
                this.mushroomQuantity = 14;
            } else {
                alert('This is the wrong number of players. Between 2 and 5 please.');
            }
        }
    }
    class information{
        constructor(){
            this.mushroomType = null;
            this.pointValue = null;
        }
    }
    class informationDeck{
        constructor(){
            this.informationPieces = [];
        }
    }
    function isGameOver(){
        var emptyBoardCount = 0;
        for(var i = 0; i < mushroomBoards.length; i++){
            var currentMushroomBoard = mushroomBoards[i];
            if(currentMushroomBoard.mushroomQuantity == 0){
                emptyBoardCount += 1;
            }
        }
        if(emptyBoardCount > 1){
            return true;
        } else {
            return false;
        }
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

    function gameSetup(inNumPlayers){
        var totalInformationDeck = new informationDeck();
        for(var mushroomType = 0; mushroomType < 4; mushroomType++){
            var mushroomInformationDeck = new informationDeck();
            for(var i = 0; i < scores.length; i++){
                var mushroomInformation = new information();
                mushroomInformation.mushroomType = mushroomType;
                mushroomInformation.pointValue = scores[i];
                mushroomInformationDeck.informationPieces.push(mushroomInformation);
            }
            var randomInformation = getRandomInt(4);
            var chosenInfo = mushroomInformationDeck.informationPieces.splice(randomInformation, 1);

            currentMushroomBoard = new mushroomBoard(mushroomType, inNumPlayers);
            currentMushroomBoard.information = chosenInfo[0];
            mushroomBoards.push(currentMushroomBoard);
            for(var j = 0; j < mushroomInformationDeck.informationPieces.length; j++){
                totalInformationDeck.informationPieces.push(mushroomInformationDeck.informationPieces[j]);
            }
        }

        for(var playerIndex = 0; playerIndex < inNumPlayers; playerIndex++){
            var newPlayer = new player(playerIndex);
            newPlayer.maxAvailableCrates = 5;
            newPlayer.availableCrates = newPlayer.maxAvailableCrates;
            newPlayer.skipped = false;

            if(inNumPlayers == 2){
                for(var k = 0; k < 4; k++){
                    var info = takeRandomInformation(totalInformationDeck);
                    newPlayer.informationPieces.push(info);
                }
                //Left over cards
                informationFlipDeck = totalInformationDeck;
            } else if(inNumPlayers == 3){
                for(var k = 0; k < 4; k++){
                    var info = takeRandomInformation(totalInformationDeck);
                    newPlayer.informationPieces.push(info);
                }
            } else if(inNumPlayers == 4){
                for(var k = 0; k < 3; k++){
                    var info = takeRandomInformation(totalInformationDeck);
                    newPlayer.informationPieces.push(info);
                }
            } else if(inNumPlayers == 5){
                for(var k = 0; k < 2; k++){
                    var info = takeRandomInformation(totalInformationDeck);
                    newPlayer.informationPieces.push(info);
                }
                //Last cards are not used
            }
            players.push(newPlayer);
        }
        firstPlayer = 0;
        currentPlayer = firstPlayer;
    }

    function takeRandomInformation(inInformationDeck){
        var randomInformation = getRandomInt(inInformationDeck.informationPieces.length);
        var chosenInfo = inInformationDeck.informationPieces.splice(randomInformation, 1);
        return chosenInfo[0];
    }

    function choosePlayers(inPlayerNumber){
        $("#setup").hide();
        gameSetup(inPlayerNumber);
        refreshMushroomBoards();
        refreshPlayerBoards();
        showSecretsActions();
        gameLoop();
    }

    function refreshMushroomBoards(){
        var mushroomBoardString = '';
        for(var i = 0; i < mushroomBoards.length; i++){
            var mushroomBoard = mushroomBoards[i];
            var cratesString = "<div>";
            for(var j = 0; j < mushroomBoard.crates.length; j++){
                var cratePlayer = mushroomBoard.crates[j];
                var crateCount = getCrateCost(j);
                cratesString += "<div>Crate Number: " + crateCount + " Crate Player: " + getPlayerColor(cratePlayer) + "</div>";
            }
            cratesString += "</div>";
            var informationString = "<div>";
            for(var k = 0; k < mushroomBoard.sharedInformation.length; k++){
                var sharedValue = mushroomBoard.sharedInformation[k].pointValue;
                informationString += "<div>Shared Value: " + sharedValue + "</div>";
            }
            informationString += "</div>";
            //TODO add informationString
            mushroomBoardString += "<div>Mushroom Type: "+getMushroomName(mushroomBoard.mushroomType)+" Quantity: "+mushroomBoard.mushroomQuantity+" " + cratesString + informationString +"</div>";
            if(isGameOver()){
                mushroomBoardString += "<div>Value: " + mushroomBoard.information.pointValue + "</div>";
            }
        }
        $("#mushroomBoards").html(mushroomBoardString);
    }

    function getCrateCost(index){
        return crateNumbers[index];
    }

    function getMushroomName(typeIndex){
        return mushroomNames[typeIndex];
    }

    function getPlayerColor(playerIndex){
        if(playerIndex == null){
            return 'Empty';
        } else {
            return playerColors[playerIndex];
        }
    }

    function refreshPlayerBoards(){
        var playerBoardString = '';
        for(var i = 0; i < players.length; i++){
            var playerString = '<div style="background-color:' + getPlayerColor(i) + '">' + getPlayerColor(i);
            var currentPlayerObject = players[i];
            for(var j = 0; j < currentPlayerObject.mushrooms.length; j++){
                playerString += '<div>' + currentPlayerObject.mushrooms[j] + ' X ' + getMushroomName(j) + '</div>';
            }
            playerString += '<div>'+currentPlayerObject.availableCrates+' X Crates</div>';
            playerString += '<div>Turn skipped '+currentPlayerObject.skipped+'</div>';
            if(isGameOver()){
                playerString += '<div>Points: ' + currentPlayerObject.points + '</div>';
            }
            playerString += '</div>';
            playerBoardString += playerString;
        }
        $("#playerBoards").html(playerBoardString);
    } 

    function gameLoop(){
        showTurn();
        showActions();
    }

    function showTurn(){
        $("#current").html("Current Turn: " + getPlayerColor(currentPlayer));
    }

    function getNextPlayer(){
        currentPlayer += 1;
        if(currentPlayer >= players.length){
            currentPlayer = 0;
        }
    }

    function clearActions(){
        //Temp probably just have different actions
        $("#actions").html('');
    }
    
    function showActions(){
        var actionString = '';
        var currentPlayerObject = players[currentPlayer];
        if(currentPlayerObject.skipped == true){
            pass();
        } else {
            var crates = currentPlayerObject.availableCrates;
            for(var i = 0; i < mushroomBoards.length; i++){
                var currentMushroomBoard = mushroomBoards[i];
                if(currentMushroomBoard.mushroomQuantity > 0){
                    var cost = getMushroomCost(currentMushroomBoard);
                    if(cost != null && crates >= cost){
                        actionString += '<input type="button" value="Buy a ' + getMushroomName(currentMushroomBoard.mushroomType) + ' for ' + cost + ' crates" onclick="buyMushroom('+i+', '+cost+')">';
                    }
                }
            }
            actionString += '<input type="button" value="Pass" onclick="pass()">';
            $("#actions").html(actionString);
        }
    }

    function getMushroomCost(inMushroomBoard){
        for(var i = 0; i < inMushroomBoard.crates.length; i++){
            var cratePlayer = inMushroomBoard.crates[i];
            if(cratePlayer == null){
                return getCrateCost(i);
            }
        }
        return null;
    }

    function buyMushroom(mushroomType, cost){
        var mushroomBoard = mushroomBoards[mushroomType];
        var currentPlayerObject = players[currentPlayer];
        currentPlayerObject.availableCrates -= cost;
        putCratesOnMushroomBoard(mushroomBoard, currentPlayer);
        mushroomBoard.mushroomQuantity -= 1;
        currentPlayerObject.mushrooms[mushroomType] += 1;
        getNextPlayer();
        refreshMushroomBoards();
        refreshPlayerBoards();
        showTurn();
        showActions();
    }

    function pass(){
        players[currentPlayer].skipped = true;
        getNextPlayer();
        refreshMushroomBoards();
        refreshPlayerBoards();
        var skippedPlayerCount = 0;
        for(var i = 0; i < players.length; i++){
            if(players[i].skipped == true){
                skippedPlayerCount += 1;
            }
        }
        if(skippedPlayerCount == players.length){
            getBonus();
            clearCrates();
            refreshMushroomBoards();
            refreshPlayerBoards();
            firstPlayer += 1;
            if(firstPlayer >= players.length){
                firstPlayer = 0;
            }
            clearActions();
            if(isGameOver()){
                $('#secrets').html('');
                console.log('Game Over');
                //Points
                for(var i = 0; i < players.length; i++){
                    var player = players[i];
                    player.points = 0;
                    for(var j = 0; j < player.mushrooms.length; j++){
                        var mushroomCount = player.mushrooms[j];
                        var mushroomType = j;
                        var mushroomValue = mushroomBoards[j].information.pointValue;
                        player.points += mushroomCount * mushroomValue;
                    }
                }
                //Winner and Ties
                winners = [];
                var maxScore = 0;
                var maxCount = 0;
                for(var k = 0; k < players.length; k++){
                    var playerObject = players[k]
                    var sumMushrooms = playerObject.mushrooms.reduce((partialSum, a) => partialSum + a, 0);
                    //More Points
                    if(playerObject.points > maxScore){
                        winners = [k];
                        maxScore = playerObject.points;
                        maxCount = sumMushrooms;
                    //Tie
                    } else if(playerObject.points == maxScore){
                        //More mushrooms
                        if(sumMushrooms > maxCount){
                            winners = [k];
                            maxCount = sumMushrooms;
                        } else if(sumMushrooms == maxCount) {
                            //Same mushroom count
                            winners.push(k);
                        }
                    }
                }
                //winners
                showWinners(maxScore, maxCount);
                refreshPlayerBoards();
                refreshMushroomBoards();
            } else {
                //TODO Information Sharing / bonus crate
                startSharePlayer = currentPlayer;
                showShareOptions();
            }
        } else {
            showTurn();
            showActions();
        }
    }

    function showShareOptions(){
        showTurn();
        var shareString = '';
        var currentPlayerObject = players[currentPlayer];
        var informationPieces = currentPlayerObject.informationPieces;
        for(var i = 0; i < informationPieces.length; i++){
            shareString += '<input type="button" value="Share Information card ' + (i + 1) + '" onclick="share('+i+')">';
        }
        shareString += '<input type="button" value="Pass" onclick="passShare()">';


        $('#actions').html(shareString);
    }

    function share(informationIndex){
        console.log('Share: ' + informationIndex);
        var currentPlayerObject = players[currentPlayer];
        var chosenInfo = currentPlayerObject.informationPieces.splice(informationIndex, 1)[0];
        var mushroomType = chosenInfo.mushroomType;
        var currentMushroomBoard = mushroomBoards[mushroomType];
        currentMushroomBoard.sharedInformation.push(chosenInfo);
        finishShare();
    }

    function passShare(){
        finishShare();
    }

    function finishShare(){
        getNextPlayer();
        refreshMushroomBoards();
        refreshPlayerBoards();
        if(startSharePlayer == currentPlayer){
            //Start next harvest phase
            currentPlayer = firstPlayer;
            showTurn();
            showActions();
        } else {
            showShareOptions();
        }
    }

    function showWinners(maxScore, maxCount){
        var winnerString = '';
        winnerString += '<div>Score: ' + maxScore +'</div>'
        winnerString += '<div>Mushroom Count: ' + maxCount +'</div>'
        for(var i = 0; i < winners.length; i++){
            var winner = winners[i];
            winnerString += '<div>Winner: ' + getPlayerColor(winner)+'</div>';
        }
        $('#winners').html(winnerString);
    }

    function refreshPeak(){
        var peakString = '';
        var playerInfo = players[currentPlayer].informationPieces;
        for(var i = 0; i < playerInfo.length; i++) {
            peakString += '<div>Mushroom Type: '+getMushroomName(playerInfo[i].mushroomType)+' Point Value: '+playerInfo[i].pointValue+'<div>'
        }
        $("#peak").html(peakString);
    }

    function clearCrates(){
        for(var i = 0; i < mushroomBoards.length; i++){
            var currentMushroomBoard = mushroomBoards[i];
            currentMushroomBoard.crates = [null, null, null, null, null];
        }
        for(var j = 0; j < players.length; j++){
            var playerObject = players[j];
            playerObject.availableCrates = playerObject.maxAvailableCrates;
            playerObject.skipped = false;
        }
    }

    function getBonus(){
        for(var i = 0; i < mushroomBoards.length; i++){
            var totalCrates = [];
            for(var j = 0; j < players.length; j++){
                totalCrates.push(0);
            }
            var currentMushroomBoard = mushroomBoards[i];
            if(currentMushroomBoard.mushroomQuantity > 0){
                for(var k = 0; k < currentMushroomBoard.crates.length; k++){
                    var cratePlayer = currentMushroomBoard.crates[k];
                    if(cratePlayer != null){
                        totalCrates[cratePlayer] += getCrateCost(k);
                    }
                }
                var mostPlayer = null;
                var mostValue = 0;
                for(var l = 0; l < totalCrates.length; l++){
                    if(totalCrates[l] > mostValue){
                        mostValue = totalCrates[l];
                        mostPlayer = l;
                    } else if(totalCrates[l] == mostValue){
                        mostPlayer = null;
                    }
                }
                if(mostPlayer != null){
                    currentMushroomBoard.mushroomQuantity -= 1;
                    players[mostPlayer].mushrooms[i] += 1;
                }
            }
        }
    }

    function putCratesOnMushroomBoard(inMushroomBoard, playerIndex){
        for(var i = 0; i < inMushroomBoard.crates.length; i++){
            var cratePlayer = inMushroomBoard.crates[i];
            if(cratePlayer == null){
                inMushroomBoard.crates[i] = playerIndex;
                return;
            }
        }
    }

    function unpeak(){
        $("#peak").html('');
    }

    function showSecretsActions(){
        $('#secrets').html('<input id="peakbutton" type="button" value="Peak" onmousedown="refreshPeak()" onmouseup="unpeak()" onmouseout="unpeak()">');
    }
    
</script>
<div id="setup">
    <form>
        <input type="button" value="2 Players" onclick="choosePlayers(2);">
        <input type="button" value="3 Players" onclick="choosePlayers(3);">
        <input type="button" value="4 Players" onclick="choosePlayers(4);">
        <input type="button" value="5 Players" onclick="choosePlayers(5);">
    </form>
</div>
<div id="mushroomBoards"></div>
<div id="playerBoards"></div>
<div id="current"></div>
<div id="actions"></div>
<div id="gameHistory"></div>
<div id="secrets"></div>
<div id="peak"></div>
<div id="winners"></div>
</body>
</html>